<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Checkinn - Información Alojamiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="favicon" type="image/png" href="/images/icon.png" sizes="32x32">
</head>
<body class="bg-gray-100 font-sans min-h-screen">
<header class="bg-white shadow-sm flex flex-col md:flex-row items-center justify-between px-8 py-4 border-b">
    <div class="flex items-center gap-6">
        <img class="w-24 h-18" src="/images/logo.png" alt="Logo">
        <nav class="flex flex-wrap gap-4 text-xl font-bold">
            <a href="Index.html" class="text-xl text-orange-500">Home</a>
            <a href="ListadoReservas.html" class="text-xl hover:text-orange-500">Mis reservas</a>
            <a href="ListadoApartamentos.html" class="text-xl hover:text-orange-500">Mis Alojamientos</a>
            <a href="AreaPersonal.html" class="text-xl hover:text-orange-500">Área personal</a>
        </nav>
    </div>
    <div class="relative inline-block text-left">
        <!-- Botón que despliega el menú -->
        <div class="flex items-center gap-2 mt-4 md:mt-0 cursor-pointer" onclick="toggleMenu()">
            <img class="w-10 h-10 rounded-full" src="/images/defaultAvatar.jpg" alt="Avatar" onerror="this.onerror=null;this.src='/images/imgAlojamientoDefault.png';"/>
            <span class="font-semibold text-sm">
      <span name="nombre">Usuario</span><br/>
      <small name="rol">Rol</small>
    </span>
        </div>

        <!-- Menú desplegable -->
        <div id="userMenu" class="hidden absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg z-50">
            <ul class="py-1 text-sm text-gray-700">
                <li>
                    <button onclick="irAreaPersonal()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">
                        Área personal
                    </button>
                </li>
                <li>
                    <button onclick="cerrarSesion()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">
                        Cerrar sesión
                    </button>
                </li>
            </ul>
        </div>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-10">
    <h1 class="text-4xl font-extrabold text-orange-500 text-center mb-10">Villa Chirinos</h1>
    <div class="flex flex-wrap gap-10">
        <div class="w-full md:w-[300px] flex flex-col items-center">
            <img id="imagenApto" src="" alt="Imagen del apartamento"
                 class="w-full h-48 object-cover rounded-xl bg-gray-200">

            <div class="flex items-center gap-3 rounded-md px-4 py-2 w-full justify-center shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.974a1 1 0 00.95.69h4.18c.969 0 1.371 1.24.588 1.81l-3.39 2.462a1 1 0 00-.364 1.118l1.287 3.974c.3.922-.755 1.688-1.538 1.118l-3.39-2.462a1 1 0 00-1.175 0l-3.39 2.462c-.783.57-1.838-.196-1.538-1.118l1.287-3.974a1 1 0 00-.364-1.118L2.045 9.4c-.783-.57-.38-1.81.588-1.81h4.18a1 1 0 00.95-.69l1.286-3.974z"/>
                </svg>
                <span class="text-lg font-semibold text-gray-700" id="valoracion"></span>
            </div>

            <button id="reservarBtn" type="submit" form="reservaForm" class="bg-gray-400 text-white w-full mt-4 py-3 rounded-lg cursor-not-allowed" disabled>
                Reservar
            </button>
        </div>

        <div class="flex-1 space-y-6">
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="font-semibold">Provincia</label>
                    <input type="text" name="provincia" readonly class="w-full p-3 border border-gray-300 rounded"/>
                </div>
                <div>
                    <label class="font-semibold">Dirección</label>
                    <input type="text" name="direccion" readonly class="w-full p-3 border border-gray-300 rounded"/>
                </div>
                <div>
                    <label class="font-semibold">Capacidad</label>
                    <input type="number" name="capacidad" readonly class="w-full p-3 border border-gray-300 rounded"/>
                </div>
                <div>
                    <label class="font-semibold">Precio por noche</label>
                    <input type="number" name="precio" readonly class="w-full p-3 border border-gray-300 rounded"/>
                </div>
            </div>

            <div>
                <label class="font-semibold">Descripción</label>
                <textarea name="descripcion" rows="5" readonly
                          class="w-full p-3 border border-gray-300 rounded"></textarea>
            </div>

            <div class="flex gap-6 flex-wrap">
                <label class="flex items-center gap-2"><input type="checkbox" name="wifi" disabled> WiFi</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="piscina" disabled> Piscina</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="barbacoa" disabled> Barbacoa</label>
            </div>

            <form id="reservaForm" class="pt-6">
                <h2 class="text-lg font-semibold mb-3">Fechas de reserva</h2>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="font-semibold">Entrada</label>
                        <input type="date" name="fechaInicio" id="fechaInicio" required
                               class="w-full p-3 border border-gray-300 rounded"/>
                    </div>
                    <div>
                        <label class="font-semibold">Salida</label>
                        <input type="date" name="fechaFin" id="fechaFin" required
                               class="w-full p-3 border border-gray-300 rounded"/>
                    </div>
                </div>
            </form>
        </div>
    </div>
</main>

<script src="app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

    document.addEventListener("DOMContentLoaded", async function () {

        const response = await axios.get(`${uri}/me`);

        if (response.status === 200) {
            const usuario = response.data;
            document.querySelector('span[name="nombre"]').textContent = usuario.nombre;
            document.querySelector('small[name="rol"]').textContent = usuario.rol;



            fechaInicio.addEventListener("input", verificarFechas);
            fechaFin.addEventListener("input", verificarFechas);

            const params = new URLSearchParams(window.location.search);
            const idAlojamiento = params.get("idAlojamiento");

            if (!idAlojamiento) return alert("No se proporcionó el ID del apartamento en la URL.");

            const responseGet = await axios.get(`${uri}/alojamientos/${idAlojamiento}`);

            if (responseGet.status === 200) {
                const apto = responseGet.data;
                document.getElementById("imagenApto").src=RanderizarBaseImagen64(apto.imagen);
                document.querySelector('[name="provincia"]').value = apto.provincia || '';
                document.querySelector('[name="direccion"]').value = apto.direccion || '';
                document.querySelector('[name="capacidad"]').value = apto.capacidad || '';
                document.querySelector('[name="precio"]').value = apto.precioNoche || '';
                document.querySelector('[name="descripcion"]').value = apto.descripcion || '';
                document.getElementById("valoracion").textContent = apto.valoracionMedia;

                if (Array.isArray(apto.servicios)) {
                    console.log(apto.servicios);
                    apto.servicios.forEach(servicio => {
                        console.log(servicio.toLowerCase());
                        const checkbox = document.querySelector(`input[name="${servicio.toLowerCase()}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                document.addEventListener('click', function (event) {
                    const menu = document.getElementById('userMenu');
                    const button = event.target.closest('.inline-block');
                    if (!button) {
                        menu.classList.add('hidden');
                    }
                });

                document.querySelector("#reservaForm").addEventListener("submit", async function (event) {
                    event.preventDefault();
                    const formData = new FormData(event.target);
                    const datos = Object.fromEntries(formData.entries());

                    const params = new URLSearchParams(window.location.search);
                    datos.idAlojamiento = params.get("idAlojamiento");
                    datos.idUsuario = String(usuario.id);

                    try {
                        const responsePost = await axios.post(`${uri}/reservas`, datos);
                        if (responsePost.status === 201) {
                            window.location.href = "ListadoReservas.html";
                        } else {
                            alert("Error durante la reserva")
                        }
                    } catch (error) {
                        if (error.response.status === 409) {
                            alert("Las fechas indicadas no estan disponibles, consulta alojamientos disponibles en el filtro");
                        } else {
                            alert("Error del servidor al intentar crear la reserva");
                        }
                    }
                });
            } else {
                alert("Error del servidor al intentar cargar la informacion del alojamiento)");
            }
        } else {
            alert(mensajeErrorDatosUsuario)
            window.location.href = "Login.html";
        }
    });

    // Este esta solo para testeos, hay que modificarlo por el de abajo
    function verificarFechas() {

        const fechaInicio = document.getElementById("fechaInicio");
        const fechaFin = document.getElementById("fechaFin");
        const reservarBtn = document.getElementById("reservarBtn");

        if (fechaInicio.value && fechaFin.value) {
            reservarBtn.disabled = false;
            reservarBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
            reservarBtn.classList.add("bg-orange-500", "hover:bg-orange-600", "cursor-pointer");
        } else {
            reservarBtn.disabled = true;
            reservarBtn.classList.remove("bg-orange-500", "hover:bg-orange-600", "cursor-pointer");
            reservarBtn.classList.add("bg-gray-400", "cursor-not-allowed");
        }
    }

    // Comentado para testeos
    // function verificarFechas() {
    //
    //     const fechaInicioDom = document.getElementById("fechaInicio");
    //     const fechaFinDom = document.getElementById("fechaFin");
    //     const reservarBtn = document.getElementById("reservarBtn");
    //
    //     if (fechaInicioDom.value && fechaFinDom.value) {
    //         const fechaInicio = new Date(document.getElementById("fechaInicio").value);
    //         const fechaFin = new Date(document.getElementById("fechaFin").value);
    //         const hoy = new Date();
    //         hoy.setHours(0, 0, 0, 0); // Ignorar la hora para comparar solo la fecha
    //
    //         if (fechaInicio > fechaFin || fechaInicio <= hoy || fechaFin <= hoy) {
    //             reservarBtn.disabled = true;
    //             reservarBtn.classList.remove("bg-orange-500", "hover:bg-orange-600", "cursor-pointer");
    //             reservarBtn.classList.add("bg-gray-400", "cursor-not-allowed");
    //         } else {
    //             reservarBtn.disabled = false;
    //             reservarBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
    //             reservarBtn.classList.add("bg-orange-500", "hover:bg-orange-600", "cursor-pointer");
    //         }
    //     } else {
    //         reservarBtn.disabled = true;
    //         reservarBtn.classList.remove("bg-orange-500", "hover:bg-orange-600", "cursor-pointer");
    //         reservarBtn.classList.add("bg-gray-400", "cursor-not-allowed");
    //     }
    // }
    function toggleMenu() {
        const menu = document.getElementById('userMenu');
        menu.classList.toggle('hidden');
    }
</script>
</body>
</html>
