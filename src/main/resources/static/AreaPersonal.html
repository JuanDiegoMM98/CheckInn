<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Área Personal</title>
  <link href="styles.css" rel="stylesheet">
  <style>

    h2 {
      color: orange;
      text-align: center;
      margin-bottom: 40px;
    }

    form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px 40px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #999;
      box-sizing: border-box;
    }

    .campo {
      display: flex;
      flex-direction: column;
    }

    .obligatorio {
      grid-column: span 2;
      color: red;
      font-size: 0.9em;
    }

    .botones {
      grid-column: span 2;
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }



    .botones button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }

    .borrar {
      background-color: rgb(233, 102, 102);
    }

    .cancelar {
      background-color: #ccc;
      color: #333;
    }

    .guardar {
      background-color: orange;
      color: white;
    }
  </style>
</head>
<body>
<!-- Menú superior -->
<header class="navbar">
  <div class="navbar-left">
    <img class="logo" src="https://via.placeholder.com/40" alt="Logo" />
    <nav>
      <a href="Home.html">Home</a>
      <a href="ListadoReservas.html">Mis reservas</a>
      <a href="ListadoApartamentos.html">Mis Apartamentos</a>
      <a href="AreaPersonal.html" class="active">Área personal</a>
    </nav>
  </div>
  <div class="navbar-right">
    <img class="avatar" src="https://via.placeholder.com/40" alt="Avatar" />
    <span name="nombreUsuario"><br><small name="rolUsuario"></small></span>
  </div>
</header>

<div class="form-container">
  <h2>Área personal</h2>
  <form>
    <div class="campo">
      <label>Nombre (*)</label>
      <input type="text" name="nombre" value="" />
    </div>

    <div class="campo">
      <label>Correo electrónico (*)</label>
      <input type="email" name="correo" value="" />
    </div>

    <div class="campo">
      <label>Apellido 1 (*)</label>
      <input type="text" name="apellido1" value="" />
    </div>

    <div class="campo">
      <label>Apellido 2 (*)</label>
      <input type="text" name="apellido2" value="" />
    </div>

    <div class="campo">
      <label>Fecha de nacimiento (*)</label>
      <input type="date" name="fechaNacimiento" value="" />
    </div>

    <div class="campo">
      <label>Dirección (*)</label>
      <input type="text" name="direccion" value="" />
    </div>

    <div class="campo">
      <label>Género</label>
      <select name="genero">
        <option value="MASCULINO">Masculino</option>
        <option value="FEMENINO">Femenino</option>
        <option></option>
      </select>
    </div>

    <div class="campo">
      <label>Teléfono de contacto</label>
      <input type="tel" name="telefono" value="666585232" />
    </div>

    <div class="campo">
      <label>Tarjeta de crédito</label>
      <input type="text" name="tarjetaBancaria" value="1585325899462" />
    </div>

    <div class="obligatorio">Los campos marcados con (*) son obligatorios</div>

    <div class="botones">
      <button class="borrar" type="reset">Borrar datos</button>
      <button class="cancelar" type="button">Cancelar</button>
      <button class="guardar" type="submit">Guardar</button>
    </div>
  </form>
</div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="app.js"></script>
  <script>

    // Formatear género
    /* En desuso (No hace falta, usarlo hacía que no se reconociera los géneros)
    function formatearGenero(texto) {
      if (!texto || typeof texto !== 'string') return ''; // Maneja null, undefined o vacío
      texto = texto.trim().toLowerCase(); // Elimina espacios y pone todo en minúscula
      return texto.charAt(0).toUpperCase() + texto.slice(1);
    }
    */

    // Cargar datos usuario

    const usuarioGuardado = sessionStorage.getItem("nombre");

    document.addEventListener("DOMContentLoaded", async function() {

      // Mostrar nombre y rol del usuario guardado en sessionStorage

        if (usuarioGuardado) {
          const usuario = JSON.parse(usuarioGuardado);

          const nombreElement = document.querySelector('span[name="nombreUsuario"]');
          const rolElement = document.querySelector('small[name="rolUsuario"]');

          document.querySelector('[name="nombre"]').value = usuario.nombre
          document.querySelector('[name="correo"]').value = usuario.correo
          document.querySelector('[name="apellido1"]').value = usuario.apellido1
          document.querySelector('[name="apellido2"]').value = usuario.apellido2
          document.querySelector('[name="fechaNacimiento"]').value = usuario.fechaNacimiento
          document.querySelector('[name="direccion"]').value = usuario.direccion
          document.querySelector('[name="genero"]').value = usuario.genero
          document.querySelector('[name="telefono"]').value = usuario.telefono
          document.querySelector('[name="tarjetaBancaria"]').value = usuario.tarjetaBancaria

          if (nombreElement && rolElement) {
            nombreElement.innerHTML = `${usuario.nombre}<br><small name="rol">${usuario.rol}</small>`;
          }

          //Petición actualizar usuario
          document.querySelector("form").addEventListener("submit", async function(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const datos = Object.fromEntries(formData.entries());

            if (usuarioGuardado) {
              const usuario = JSON.parse(usuarioGuardado);
              datos.rol = usuario.rol;
              datos.contraseña = usuario.contraseña;
            }

            try {
              const response = await axios.patch(`${uri}/usuarios/${usuario.dni}`, datos);

              if (response.status === 200) {
                guardar_session(response.data);
                window.location.href = "Home.html";
              } else if (response.status === 404) {
                alert("Modificación de datos fallida");
              } else {
                alert("Ha habido un error al actualizar los datos");
              }
            } catch (error) {
              /*
                console.error("Error:", error);
                alert("Error al conectar con el servidor.");
                */
            }
          });

          // Eliminar usuario
          document.querySelector("form").addEventListener("reset", async function(event) {
            event.preventDefault();

            const confirmacion = confirm("¿Estás seguro de que deseas eliminar tu cuenta? Esta acción no se puede deshacer.");

            if (!confirmacion) return; // El usuario canceló

            if (usuarioGuardado) {
              const usuario = JSON.parse(usuarioGuardado);
              const response = await axios.delete(`${uri}/usuarios/${usuario.dni}`)

              if (response.status === 200) {
                window.location.href = "Index.html";
              } else if (response.status === 404) {
                alert("No se ha encontrado el usuario en la base de datos");
              } else {
                alert("Error al intentar eliminar el usuario");
              }
            }
          });

          document.querySelector("form").addEventListener("click", async function(event) {
            window.location.href = "Home.html";
          });
        }



          /*
          const response = axios.get(`${uri}/usuarios/${usuario.dni}`);
          if (response.status === 200) {

            const datosUsuario = response.data;

           */


/*
          } else {
            alert("Error al obtener los datos de usuario");
          }
      } else {
        alert("Error al acceder a los datos de inicio de sesión");
      }
      */
    });
  </script>
</body>
</html>
