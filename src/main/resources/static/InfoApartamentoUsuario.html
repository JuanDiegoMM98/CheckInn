<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Checkinn - Información Alojamiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="/images/icon.png" sizes="32x32">
</head>
<body class="bg-gray-100 font-sans min-h-screen">
<header class="bg-white shadow-sm flex flex-col md:flex-row items-center justify-between px-8 py-4 border-b">
    <div class="flex items-center gap-6">
        <img class="w-24 h-18" src="/images/logo.png" alt="Logo">
        <nav class="flex flex-wrap gap-4 text-xl font-bold">
            <a href="Index.html" class="text-xl hover:text-orange-500">Home</a>
            <a href="ListadoReservas.html" class="text-xl hover:text-orange-500">Mis reservas</a>
            <a href="ListadoApartamentos.html" class="text-xl text-orange-500">Mis Alojamientos</a>
            <a href="AreaPersonal.html" class="text-xl hover:text-orange-500">Área personal</a>
        </nav>
    </div>
    <div class="relative inline-block text-left">
        <!-- Botón que despliega el menú -->
        <div class="flex items-center gap-2 mt-4 md:mt-0 cursor-pointer" onclick="toggleMenu()">
            <img class="w-10 h-10 rounded-full" src="/images/defaultAvatar.jpg" alt="Avatar"/>
            <span class="font-semibold text-sm">
      <span name="nombre">Usuario</span><br/>
      <small name="rol">Rol</small>
    </span>
        </div>

        <!-- Menú desplegable -->
        <div id="userMenu" class="hidden absolute right-0 mt-2 w-40 bg-white rounded-md shadow-lg z-50">
            <ul class="py-1 text-sm text-gray-700">
                <li>
                    <button onclick="irAreaPersonal()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">
                        Área personal
                    </button>
                </li>
                <li>
                    <button onclick="cerrarSesion()" class="block w-full text-left px-4 py-2 hover:bg-gray-100">
                        Cerrar sesión
                    </button>
                </li>
            </ul>
        </div>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4">
    <h1 class="text-4xl font-extrabold text-orange-500 text-center mt-10 mb-6">Información del alojamiento</h1>
    <div class="flex flex-wrap gap-10">
        <div class="w-full md:w-[300px] flex flex-col items-center">
            <img
                    id="imagenApartamento"
                    alt="Imagen del apartamento"
                    class="w-full aspect-video object-cover rounded-lg border border-gray-300 block"
                    onerror="this.onerror=null;this.src='/images/imgAlojamientoDefault.png';"
            />
            <label for="inputImagen" class="bg-gray-100 cursor-pointer text-blue-600 hover:underline">Cambiar imagen</label>
            <input
                    type="file"
                    id="inputImagen"
                    name="imagen"
                    accept="image/*"
                    class="hidden"
            />
            <div class="flex items-center gap-3 rounded-md px-4 py-2 w-full justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.974a1 1 0 00.95.69h4.18c.969 0 1.371 1.24.588 1.81l-3.39 2.462a1 1 0 00-.364 1.118l1.287 3.974c.3.922-.755 1.688-1.538 1.118l-3.39-2.462a1 1 0 00-1.175 0l-3.39 2.462c-.783.57-1.838-.196-1.538-1.118l1.287-3.974a1 1 0 00-.364-1.118L2.045 9.4c-.783-.57-.38-1.81.588-1.81h4.18a1 1 0 00.95-.69l1.286-3.974z"/>
                </svg>
                <span class="text-lg font-semibold text-gray-700" id="valoracion"></span>
            </div>

            <div id="contenedorDesplegableReservas" class="bg-orange-100 pt-4 pr-4 pl-4 pb-10 rounded-xl w-full transition-colors duration-300 hidden flex flex-col items-start h-[260px]">
                <label for="reserva" class="block text-xl font-bold text-orange-700 mb-2">Solicitudes de cancelación</label>
                <select id="reserva" name="reserva" class="border p-2 rounded-lg w-full bg-white text-gray-800">
                    <option value="" disabled selected>Reservas</option>
                    <!-- Ls opciones se llenarán por JS -->a
                </select>
            </div>
        </div>

        <form id="formApartamentoUsuario" class="flex-1 space-y-6">
            <div>
                <label for="nombre" class="text-2xl font-semibold block mb-4">Nombre</label>
                <input
                        type="text"
                        id="nombre"
                        name="nombre"
                        class="w-full p-3 border border-gray-300 rounded text-2xl text-center"
                />
            </div>
            <div class="flex-1 space-y-6">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="font-semibold">Provincia</label>
                        <select id="provincia" name="provincia" class="w-full p-3 border border-gray-300 rounded">
                            <option>Álava</option>
                            <option>Albacete</option>
                            <option>Alicante</option>
                            <option>Almería</option>
                            <option>Asturias</option>
                            <option>Ávila</option>
                            <option>Badajoz</option>
                            <option>Barcelona</option>
                            <option>Burgos</option>
                            <option>Cáceres</option>
                            <option>Cádiz</option>
                            <option>Cantabria</option>
                            <option>Castellón</option>
                            <option>Ciudad Real</option>
                            <option>Córdoba</option>
                            <option>Cuenca</option>
                            <option>Girona</option>
                            <option>Granada</option>
                            <option>Guadalajara</option>
                            <option>Guipúzcoa</option>
                            <option>Huelva</option>
                            <option>Huesca</option>
                            <option>Illes Balears</option>
                            <option>Jaén</option>
                            <option>La Coruña</option>
                            <option>La Rioja</option>
                            <option>Las Palmas</option>
                            <option>León</option>
                            <option>Lleida</option>
                            <option>Lugo</option>
                            <option>Madrid</option>
                            <option>Málaga</option>
                            <option>Murcia</option>
                            <option>Navarra</option>
                            <option>Ourense</option>
                            <option>Palencia</option>
                            <option>Pontevedra</option>
                            <option>Salamanca</option>
                            <option>Santa Cruz de Tenerife</option>
                            <option>Segovia</option>
                            <option>Sevilla</option>
                            <option>Soria</option>
                            <option>Tarragona</option>
                            <option>Teruel</option>
                            <option>Toledo</option>
                            <option>Valencia</option>
                            <option>Valladolid</option>
                            <option>Vizcaya</option>
                            <option>Zamora</option>
                            <option>Zaragoza</option>
                            <option>Ceuta</option>
                            <option>Melilla</option>
                        </select>
                    </div>
                    <div>
                        <label class="font-semibold">Dirección</label>
                        <input type="text" id="direccion" name="direccion" class="w-full p-3 border border-gray-300 rounded"/>
                    </div>
                    <div>
                        <label class="font-semibold">Capacidad</label>
                        <input type="number" id="capacidad" name="capacidad"
                               class="w-full p-3 border border-gray-300 rounded"
                                min = "1"/>
                    </div>
                    <div>
                        <label class="font-semibold">Precio por noche</label>
                        <input type="number" id="precioNoche" name="precioNoche" class="w-full p-3 border border-gray-300 rounded"
                               step="0.01" min="0"/>
                    </div>
                    <div>
                        <p id="capacidadError" class="text-red-500 hidden">Capacidad no puede tener valor negativo ni 0.</p>
                    </div>
                    <div>
                        <p id="precioError" class="text-red-500 hidden">Precio no puede tener un valor negativo.</p>
                    </div>
                </div>

                <div>
                    <label class="font-semibold">Descripción</label>
                    <textarea id="descripcion" name="descripcion" rows="5"
                              class="w-full p-3 border border-gray-300 rounded"></textarea>
                </div>

                <div class="flex gap-6 flex-wrap" id="servicios">
                    <label class="flex items-center gap-2"><input name="wifi" type="checkbox" value="WIFI"> WiFi</label>
                    <label name="piscina" class="flex items-center gap-2"><input name="piscina" type="checkbox" value="PISCINA">Piscina</label>
                    <label name="barbacoa" class="flex items-center gap-2"><input name="barbacoa" type="checkbox" value="BARBACOA">Barbacoa</label>
                </div>

                <div class="pt-6">
                    <h2 class="text-lg font-semibold mb-3">Fechas en que el apartamento esta bloqueado</h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="font-semibold">Inicio</label>
                            <input type="date" name="inicioBloqueo" id="inicioBloqueo"
                                   class="w-full p-3 border border-gray-300 rounded"/>
                        </div>
                        <div>
                            <label class="font-semibold">Fin</label>
                            <input type="date" name="finBloqueo" id="finBloqueo"
                                   class="w-full p-3 border border-gray-300 rounded"/>
                        </div>
                    </div>
                </div>
                <p id="mensajeError" class="text-red-500"></p>
                <div class="pt-6 flex gap-4">
                    <button
                            id="deleteBtn"
                            type="button"
                            class="bg-red-500 text-white w-full py-3 rounded-lg hover:bg-red-600">
                        Eliminar alojamiento
                    </button>
                    <button
                            id="cancelBtn"
                            type="button"
                            class="bg-gray-300 text-gray-800 hover:bg-gray-400 w-full py-3 rounded-lg">
                        Cancelar
                    </button>
                    <button
                            id="updateBtn"
                            type="submit"
                            class="bg-orange-500 text-white hover:bg-orange-600 w-full py-3 rounded-lg">
                        Actualizar alojamiento
                    </button>
                </div>
            </div>
        </form>
        <form id="formFacturacion" class="w-full md:w-[300px] bg-orange-100 rounded-2xl p-6 max-h-[500px] flex flex-col justify-between">
            <div>
                <h2 class="text-xl font-bold text-orange-700 text-center mb-4">Facturación del alojamiento</h2>

                <div>
                    <label for="facturacionInicio" class="font-semibold block mb-1">Fecha de inicio</label>
                    <input type="date" id="facturacionInicio" name="facturacionInicio" class="w-full p-2 border border-gray-300 rounded"/>
                </div>

                <div class="mt-4">
                    <label for="facturacionFin" class="font-semibold block mb-1">Fecha de fin</label>
                    <input type="date" id="facturacionFin" name="facturacionFin" class="w-full p-2 border border-gray-300 rounded"/>
                </div>

                <button
                        id="btn-calcularFacturacion" type="submit" class="w-full bg-orange-500 text-white hover:bg-orange-600 py-2 rounded-lg mt-6">
                    Calcular
                </button>
            </div>

            <div class="mt-6">
                <label for="resultadoFacturacion" class="font-semibold block mb-1">Total estimado (€)</label>
                <input type="text" id="resultadoFacturacion" name="resultadoFacturacion" readonly class="w-full p-2 border border-gray-300 rounded bg-white"/>
            </div>
        </form>
    </div>
</main>

<script src="app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

    const params = new URLSearchParams(window.location.search);
    const idAlojamiento = params.get("idAlojamiento");

    document.addEventListener("DOMContentLoaded", async function () {

        const response = await axios.get(`${uri}/me`);

        if (response.status ===200) {
            const usuario = response.data;
            document.querySelector('span[name="nombre"]').textContent = usuario.nombre;
            document.querySelector('small[name="rol"]').textContent = usuario.rol;

            if (!idAlojamiento) return alert("No se proporcionó el ID del apartamento en la URL.");

            // Cargar datos del alojamiento
            let archivo;
            try {
                const response = await axios.get(`${uri}/alojamientos/${idAlojamiento}`);
                if (response.status === 200) {
                    const apto = response.data;
                    document.querySelector('[name="provincia"]').value = apto.provincia || '';
                    document.querySelector('[name="direccion"]').value = apto.direccion || '';
                    document.querySelector('[name="capacidad"]').value = apto.capacidad || '';
                    document.querySelector('[name="precioNoche"]').value = apto.precioNoche || '';
                    document.querySelector('[name="descripcion"]').value = apto.descripcion || '';
                    document.querySelector('[name="inicioBloqueo"]').value = apto.inicioBloqueo || '';
                    document.querySelector('[name="finBloqueo"]').value = apto.finBloqueo || '';
                    document.getElementById("imagenApartamento").src = RanderizarBaseImagen64(apto.imagen);
                    document.getElementById("valoracion").textContent = apto.valoracionMedia;
                    document.getElementById("nombre").value = apto.nombre;
                    if (Array.isArray(apto.servicios)) {
                        apto.servicios.forEach(servicio => {
                            const checkbox = document.querySelector(`input[name="${servicio.toLowerCase()}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }

                    archivo = apto.imagen;

                    try {
                        const responseReservas = await axios.get(`${uri}/alojamientos/${idAlojamiento}/reservas`);

                        if (responseReservas.status === 200) {
                            let solicitudes = 0;
                            const select = document.getElementById('reserva');
                            const reservas = responseReservas.data;
                            if (reservas.length > 0) {
                                // const opcionInicial = document.createElement('option');
                                // opcionInicial.value = "";
                                // opcionInicial.textContent = "";
                                // select.appendChild(opcionInicial);

                                reservas.forEach(reserva => {
                                    if (reserva.motivoCancelacion !== null && !reserva.cancelada && new Date(reserva.fechaInicio) > new Date()) {
                                        const option = document.createElement('option');
                                        option.classList.add("round");
                                        option.value = reserva.id;
                                        option.textContent = "ID Reserva: " + reserva.id;
                                        select.append(option);
                                        solicitudes++;
                                    }
                                });
                                if (solicitudes > 0) {
                                    document.getElementById("contenedorDesplegableReservas").classList.remove("hidden");

                                    select.addEventListener('change', (e) => {
                                        if (e.target.value !== "") {
                                            const idReserva = e.target.value;
                                            // window.location.href = `SolicitudCancelacionOwner.html?idAlojamiento=${idAlojamiento}&idReserva=${idReserva}`;
                                            window.open(`SolicitudCancelacionOwner.html?idAlojamiento=${idAlojamiento}&idReserva=${idReserva}`, '_blank');
                                        }
                                    });
                                }
                            }
                        } else {
                            alert("Error desconocido al intentar cargar las reservas del alojamiento");
                        }
                    } catch (error) {
                        if (error.response.status === 404) {
                            alert("No se ha podido encontrar el alojamiento en la base de datos");
                        } else {
                            alert("Error al intentar cargar las reservas del alojamiento.");
                        }
                    }


                    // Update alojamiento
                    document.getElementById("formApartamentoUsuario").addEventListener("submit", async function (event) {
                        event.preventDefault();

                        if (validarFormulario()) {
                            const formData = new FormData(event.target);
                            const datos = Object.fromEntries(formData.entries());

                            const serviciosSeleccionados = [];
                            document.querySelectorAll("#servicios input[type=checkbox]:checked").forEach(checkbox => {
                                serviciosSeleccionados.push(checkbox.value);
                            });

                            datos.servicios = serviciosSeleccionados;
                            datos.imagen = archivo;

                            if (datos.inicioBloqueo === "") {
                                delete datos.inicioBloqueo;
                            }
                            if (datos.finBloqueo === "") {
                                delete datos.finBloqueo;
                            }
                            if (archivo instanceof File) {
                                formData.set("imagen", archivo);
                            } else {
                                formData.delete("imagen");
                            }

                            const response = await axios.patch(`${uri}/alojamientos/${idAlojamiento}`, datos);
                            if (response.status === 200) {
                                window.location.href="ListadoApartamentos.html";
                            } else if (response.status === 404) {
                                alert("No se ha encontrado el alojamiento");
                            } else {
                                alert("Error del servidor al intentar actualizar los datos del alojamiento");
                            }
                        }
                    });

                    document.getElementById("formFacturacion").addEventListener("submit", async function (event) {
                        event.preventDefault();
                        const formData = new FormData(event.target);
                        const datos = Object.fromEntries(formData.entries());

                        try {
                            const responseFacturacion = await axios.get(`${uri}/alojamientos/${idAlojamiento}/facturacion?fechaInicio=${datos.facturacionInicio}&fechaFin=${datos.facturacionFin}`);
                            if (responseFacturacion.status === 200) {
                                document.getElementById("resultadoFacturacion").value = responseFacturacion.data.totalFacturado;
                            } else {
                                alert("Respuesta inesperada al intentar obtener la facturación")
                            }
                        } catch (error) {
                            if (error.response.status === 404) {
                                alert("No se ha encontrado el alojamiento en la base de datos");
                            } else if (error.response.status === 500) {
                                alert("Error del servidor al intentar obtener la factuación");
                            } else {
                                alert("Error desconocido al inetntar obtener la facturación");
                            }
                        }
                    })

                    document.getElementById("deleteBtn").addEventListener("click", async function (event) {
                        event.preventDefault();
                        if (confirm("¿Eliminar alojamiento? Esta acción es irreversible.")) {
                            const response = await axios.delete(`${uri}/alojamientos/${idAlojamiento}`);
                            if (response.status === 200) {
                                window.location.href="ListadoApartamentos.html";
                            } else if (response.status === 404) {
                                alert("No se pudo encontrar el alojamiento en la base de datos");
                            } else {
                                alert("Error de servidor al intentar borrar el alojamiento");
                            }
                        }
                    });

                    document.getElementById("cancelBtn").addEventListener("click", function (event) {
                        event.preventDefault();

                        window.location.href="ListadoApartamentos.html";
                    });

                    // Actualizar imagen
                    const inputImagen = document.getElementById('inputImagen');

                    inputImagen.addEventListener('change', async () => {
                        const fichero = e.target.files[0];
                        if (!fichero) return;

                        try {
                            archivo = await ficheroAImagenBase64(e.target.files[0]);
                            const dataUri = `data:${archivo.type};base64,${archivo}`;
                            document.getElementById("imagenAlojamiento").src = dataUri;
                        } catch (error) {
                            console.log(error);
                            alert("Error al intentar convertir la imagen");
                        }
                    });

                    document.addEventListener('click', function (event) {
                        const menu = document.getElementById('userMenu');
                        const button = event.target.closest('.inline-block');
                        if (!button) {
                            menu.classList.add('hidden');
                        }
                    });
                }
            } catch (error) {
                alert("Error al conectar con el servidor.");
            }
        } else {
            alert(mensajeErrorDatosUsuario);
            window.location.href = "Login.html"
        }
    });

    function validarFormulario() {
        const form = document.querySelector("form");
        const inputs = form.querySelectorAll("input:not([name='inicioBloqueo']):not([name='finBloqueo']), textarea");
        const inicioBloqueo = document.getElementById("inicioBloqueo").value;
        const finBloqueo = document.getElementById("finBloqueo").value;

        let todosLlenos = true;

        // Validar campos vacíos
        inputs.forEach(input => {
            if (input.value.trim() === "") {
                todosLlenos = false;
                input.classList.add("border-red-500");
            } else {
                input.classList.remove("border-red-500");
            }
        });

        // Validar fechas solo si están presentes
        let fechasValidas = true;
        let mensajeError = document.getElementById("mensajeError");
        const capacidad = document.getElementById("capacidad");
        const precio = document.getElementById("precioNoche");

        if (inicioBloqueo && finBloqueo) {
            const inicio = new Date(document.getElementById('inicioBloqueo').value);
            const fin = new Date(document.getElementById('finBloqueo').value);

            if (inicio >= fin) {
                fechasValidas = false;
                mensajeError.textContent = "La fecha de inicio debe ser anterior a la fecha de fin.";
            } else if (fin <= new Date()) {
                fechasValidas = false;
                mensajeError.textContent = "La fecha de fin debe ser posterior a la fecha actual.";
            }
        }

        if (capacidad.value <= 0) {
            document.getElementById("capacidadError").classList.remove("hidden");
        } else {
            document.getElementById("capacidadError").classList.add("hidden");
        }

        if (precio.value < 0) {
            document.getElementById("precioError").classList.remove("hidden");
        } else {
            document.getElementById("precioError").classList.add("hidden");
        }
        // Mostrar errores si hay
        if (!todosLlenos || !fechasValidas) {
            if (mensajeError) alert(mensajeError.textContent);
            else mensajeError.textContent = "Por favor, completa todos los campos obligatorios.";
            return false;
        }
        return true;
    }

    function toggleMenu() {
        const menu = document.getElementById('userMenu');
        menu.classList.toggle('hidden');
    }
</script>
</body>
</html>
